#!/bin/sh
#
# Bootstrap the SimplePost configure script with GNU autotools.
#
# Copyright (C) 2015 Karl Lenz.  All rights reserved.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public
# License along with this program; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 021110-1307, USA.
#

###############################################################################
# Utility Functions
###############################################################################

## Is version one less than or equal to version two?
verlte()
{
	[ "$1" = "$(echo $1'='$2 | tr '=' '\n' | sort -V | head -n 1)" ]
}

###############################################################################
# Environment Configuration
###############################################################################

## Get the minimum autoconf version required for bootstrap.
env_get_ac_prereq()
{
	if [ ! -e configure.ac ]; then
		echo "Error: Missing configure.ac" 1>&2
		exit 1
	fi

	ac_prereq=$(cat configure.ac | grep AC_PREREQ | head -n 1 | grep -Eo '([0-9]+\.)[0-9]+')
	if [ "x$ac_prereq" = "x" ]; then
		echo "Error: Failed to get AC_PREREQ from configure.ac" 1>&2
		exit 1
	fi
}

## Try to find an appropriate autoreconf to bootstrap.
env_find_ac()
{
	env_get_ac_prereq
	echo -n "checking for autoreconf... " 1>&2
	unset ac
	for __file in $(echo $PATH | tr ':' ' '); do
		for __ac in $(find $__file -executable -name 'autoreconf*'); do
			__ac_ver=$($__ac --version | grep -Eo '([0-9]+\.)[0-9]+' | head -n 1)
			if [ "x$__ac_ver" != "x" ] && verlte $ac_prereq $__ac_ver; then
				ac=$__ac
				break
			fi
		done
	done
	if [ "x$ac" = "x" ]; then
		echo "not found" 1>&2
		exit 1
	else
		echo "$__ac_ver" 1>&2
	fi
}

###############################################################################
# Actions
###############################################################################

## Cleanup the artifacts generated by bootstrap and configure.
action_clean()
{
	rm -vf aclocal.m4
	rm -vrf autom4te.cache/
	rm -vrf build-aux/
	rm -vf config.*

	find -type f -executable -name configure -exec rm -vf {} \;
	find -type f -executable -name simplepost -exec rm -vf {} \;

	find -type f -name Makefile -exec rm -vf {} \;
	find -type f -name Makefile.in -exec rm -vf {} \;

	rm -vf INSTALL
	rm -vf src/config.h

	find -type f -name 'stamp-h?' -exec rm -vf {} \;
	find -type f -name '*.o' -exec rm -vf {} \;
	find -type d -name .deps -exec rm -vrf {} \;
}

## Generate the build scripts from source.
action_generate()
{
	env_find_ac
	echo -n "generating configure... " 1>&2
	if $ac --force --install; then
		echo "yes" 1>&2
	else
		echo "no" 1>&2
		exit 1
	fi
}

## Print our help information.
action_help()
{
	echo "Usage: $0 [ACTION]

Actions:
  gen|generate             generate the build scripts for SimplePost
  clean                    cleanup the artifacts generated by bootstrap and configure
"
}

###############################################################################
# Entry Point
###############################################################################

action='generate'

while [ $# -gt 0 ]; do
	case "$1" in
		gen|generate)
			action='generate'
			;;

		clean)
			action='clean'
			;;

		help|--help)
			action='help'
			;;

		*)
			echo "Invalid Action: $1" 1>&2
			exit 1
			;;
	esac
	shift
done

action_$action
exit 0
